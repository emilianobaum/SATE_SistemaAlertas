package com.sate.ui;

import javax.swing.*;
import javax.swing.table.DefaultTableModel;
import java.awt.*;
import java.util.List;

public class SATE_App {
    public static void main(String[] args) {
        // SwingUtilities reside en javax.swing y es necesario para iniciar la UI
        SwingUtilities.invokeLater(() -> new LoginScreen().setVisible(true));
	    }
	}

// ----------------------------------------------------------------------------------
// PANTALLA 1: LOGIN
// ----------------------------------------------------------------------------------

class LoginScreen extends JFrame {
    public LoginScreen() {
        setTitle("SATE - Acceso al Sistema");
        setSize(400, 250);
        setDefaultCloseOperation(JFrame.EXIT_ON_CLOSE);
        setLocationRelativeTo(null); // Centrar la ventana
        setLayout(new BorderLayout(10, 10)); // Usamos BorderLayout

        // Panel principal con GridBagLayout para centrar y alinear
        JPanel mainPanel = new JPanel(new GridBagLayout());
        GridBagConstraints gbc = new GridBagConstraints();
        gbc.insets = new Insets(5, 5, 5, 5);
        gbc.fill = GridBagConstraints.HORIZONTAL;

        // Título
        JLabel title = new JLabel("🔑 Login de Usuario", SwingConstants.CENTER);
        title.setFont(new Font("Segoe UI", Font.BOLD, 18));
        gbc.gridx = 0;
        gbc.gridy = 0;
        gbc.gridwidth = 2;
        mainPanel.add(title, gbc);

        // Campos de texto
        gbc.gridwidth = 1;
        gbc.gridx = 0;
        gbc.gridy = 1;
        mainPanel.add(new JLabel("Usuario (Email):"), gbc);
        gbc.gridx = 1;
        JTextField emailField = new JTextField(20);
        mainPanel.add(emailField, gbc);

        gbc.gridx = 0;
        gbc.gridy = 2;
        mainPanel.add(new JLabel("Contraseña:"), gbc);
        gbc.gridx = 1;
        JPasswordField passwordField = new JPasswordField(20);
        mainPanel.add(passwordField, gbc);

        // Panel de Botones
        JPanel buttonPanel = new JPanel(new FlowLayout(FlowLayout.CENTER, 15, 5));
        JButton loginButton = new JButton("Iniciar Sesión");
        JButton registerButton = new JButton("Registrarse");
        
        // Simulación de interacción: Abrir pantalla principal al hacer login
        loginButton.addActionListener(e -> {
            dispose(); // Cierra la ventana de login
//            String userEmail = emailField.getText().toLowerCase();
//            if (userEmail.equals("admin@sate.com")) {
//                // Abre la pantalla completa de Gestión de Administrador
//                new AdminScreen().setVisible(true); 
//            } else if (userEmail.equals("validador@sate.com")) {
//                // El validador va directo a la validación de reportes
//                new ValidationScreen().setVisible(true); 
//            } else {
//                // Ciudadano o rol por defecto
//                new MainDashboard().setVisible(true); 
//            }
        });

        // Simulación de interacción: Abrir registro
        registerButton.addActionListener(e -> new RegisterScreen().setVisible(true));

        buttonPanel.add(loginButton);
        buttonPanel.add(registerButton);

        gbc.gridx = 0;
        gbc.gridy = 3;
        gbc.gridwidth = 2;
        mainPanel.add(buttonPanel, gbc);

        add(mainPanel, BorderLayout.CENTER);
    }
}

// ----------------------------------------------------------------------------------
// PANTALLA 2: REGISTRO
// ----------------------------------------------------------------------------------

class RegisterScreen extends JFrame {
    public RegisterScreen() {
        setTitle("SATE - Registro de Nuevo Usuario");
        setSize(450, 300);
        setLocationRelativeTo(null);
        setLayout(new BorderLayout(10, 10));

        JPanel formPanel = new JPanel(new GridBagLayout());
        GridBagConstraints gbc = new GridBagConstraints();
        gbc.insets = new Insets(5, 5, 5, 5);
        gbc.fill = GridBagConstraints.HORIZONTAL;
        gbc.weightx = 1.0;

        // Helper para añadir campos
        int row = 0;
        formPanel.add(new JLabel("👤 Nombre Completo:"), gbc(0, row));
        formPanel.add(new JTextField(25), gbc(1, row++));
        
        formPanel.add(new JLabel("✉️ Email (Usuario):"), gbc(0, row));
        formPanel.add(new JTextField(25), gbc(1, row++));
        
        formPanel.add(new JLabel("🔑 Contraseña:"), gbc(0, row));
        formPanel.add(new JPasswordField(25), gbc(1, row++));
        
        formPanel.add(new JLabel("🔁 Repetir Contraseña:"), gbc(0, row));
        formPanel.add(new JPasswordField(25), gbc(1, row++));

        // Botones
        JPanel buttonPanel = new JPanel(new FlowLayout(FlowLayout.CENTER, 15, 5));
        buttonPanel.add(new JButton("Crear Cuenta"));
        
        JButton cancelButton = new JButton("Cancelar / Volver");
        cancelButton.addActionListener(e -> dispose());
        buttonPanel.add(cancelButton);

        add(new JLabel("SATE - Formulario de Registro", SwingConstants.CENTER), BorderLayout.NORTH);
        add(formPanel, BorderLayout.CENTER);
        add(buttonPanel, BorderLayout.SOUTH);
    }
    
    // Método helper para GridBagConstraints
    private GridBagConstraints gbc(int x, int y) {
        GridBagConstraints gbc = new GridBagConstraints();
        gbc.insets = new Insets(5, 5, 5, 5);
        gbc.fill = GridBagConstraints.HORIZONTAL;
        gbc.gridx = x;
        gbc.gridy = y;
        gbc.weightx = (x == 1) ? 1.0 : 0.0;
        return gbc;
    }
}

// ----------------------------------------------------------------------------------
// PANTALLA 3: REGISTRO DE EVENTO (Reporte Manual)
// ----------------------------------------------------------------------------------

class ReporteManualScreen extends JFrame {
    // CAMPOS DE ENTRADA NECESARIOS para ensamblar el WKT
    private JTextField latitudTextField;
    private JTextField longitudTextField;

    public ReporteManualScreen() {
        // [Código de inicialización y JTabbedPane se mantiene igual]

        setTitle("SATE - Reporte de Incidencia");
        setSize(600, 450); // Aumento del tamaño para más espacio
        setLocationRelativeTo(null);

        JTabbedPane tabbedPane = new JTabbedPane();
        
        JPanel detallesPanel = new JPanel(new GridBagLayout());
        tabbedPane.addTab("Detalles del Reporte", crearPanelDetalles(detallesPanel));

        JPanel ubicacionPanel = new JPanel(new GridBagLayout());
        tabbedPane.addTab("Ubicación", crearPanelUbicacion(ubicacionPanel));

        add(tabbedPane, BorderLayout.CENTER);
        
        // Botón Enviar en la parte inferior (Aquí se llamaría a la función de guardado)
        JPanel footerPanel = new JPanel(new FlowLayout(FlowLayout.RIGHT));
        JButton sendButton = new JButton("Enviar Reporte");
        sendButton.setFont(new Font("Segoe UI", Font.BOLD, 14));
        
        // Simulación de acción de envío
        sendButton.addActionListener(e -> {
            String wktString = generarWKT();
            JOptionPane.showMessageDialog(this, 
                "Reporte Enviado.\nCoordenadas WKT generadas:\n" + wktString, 
                "Éxito en el Envío", JOptionPane.INFORMATION_MESSAGE);
            // Aquí se llamaría a la BBDD para guardar el Evento
        });
        
        footerPanel.add(sendButton);
        add(footerPanel, BorderLayout.SOUTH);
    }

    private JPanel crearPanelDetalles(JPanel panel) {
        GridBagConstraints gbc = new GridBagConstraints();
        gbc.insets = new Insets(8, 8, 8, 8);
        gbc.fill = GridBagConstraints.HORIZONTAL;
        gbc.weightx = 1.0;
        
        // Tipo de Evento
        gbc.gridx = 0; gbc.gridy = 0; gbc.weightx = 0;
        panel.add(new JLabel("Tipo de Evento:"), gbc);
        gbc.gridx = 1; gbc.weightx = 1.0;
        String[] tipos = {"Inundación", "Incendio", "Climático", "Otro"};
        panel.add(new JComboBox<>(tipos), gbc);

        // Descripción Breve
        gbc.gridx = 0; gbc.gridy = 1; gbc.gridwidth = 2;
        panel.add(new JLabel("Descripción Breve:"), gbc);
        
        gbc.gridy = 2; gbc.weighty = 1.0; gbc.fill = GridBagConstraints.BOTH;
        JTextArea descripcionTextArea = new JTextArea(5, 20);
        descripcionTextArea.setLineWrap(true);
        panel.add(new JScrollPane(descripcionTextArea), gbc);
        
        return panel;
    }

    private JPanel crearPanelUbicacion(JPanel panel) {
        GridBagConstraints gbc = new GridBagConstraints();
        gbc.insets = new Insets(8, 8, 8, 8);
        gbc.fill = GridBagConstraints.HORIZONTAL;
        
        // Información del formato esperado
        JLabel formatInfo = new JLabel("Formato Esperado: Coordenadas Decimales (Ej: -34.6037)");
        formatInfo.setForeground(Color.BLUE);
        gbc.gridx = 0; gbc.gridy = 0; gbc.gridwidth = 2;
        panel.add(formatInfo, gbc);

        // Latitud
        latitudTextField = new JTextField(15);
        gbc.gridx = 0; gbc.gridy = 1; gbc.gridwidth = 1; panel.add(new JLabel("Latitud:"), gbc);
        gbc.gridx = 1; panel.add(latitudTextField, gbc);

        // Longitud
        longitudTextField = new JTextField(15);
        gbc.gridx = 0; gbc.gridy = 2; panel.add(new JLabel("Longitud:"), gbc);
        gbc.gridx = 1; panel.add(longitudTextField, gbc);
        
        // Botón Ubicación Actual
        gbc.gridx = 0; gbc.gridy = 3; gbc.gridwidth = 2; gbc.fill = GridBagConstraints.NONE;
        panel.add(new JButton("Usar Ubicación Actual (Simulado)"), gbc);
        
        return panel;
    }
    
    /**
     * Ensambla los campos de Latitud y Longitud en el formato WKT POINT.
     * MySQL usa WKT con el orden: LONGITUD LATITUD.
     */
    private String generarWKT() {
        // Asumiendo que el usuario ingresó números válidos.
        String lat = latitudTextField.getText().trim();
        String lon = longitudTextField.getText().trim();
        
        if (lat.isEmpty() || lon.isEmpty()) {
            return "ERROR: Latitud y Longitud son obligatorios.";
        }
        
        // Ensamblar el formato WKT POINT(Longitud Latitud)
        return "POINT(" + lon + " " + lat + ")";
    }
}

// ----------------------------------------------------------------------------------
// PANTALLA 4: VISUALIZAR EVENTOS EN EL MAPA (Dashboard Principal)
// ----------------------------------------------------------------------------------

class MainDashboard extends JFrame {

    private GISMapPanel mapPanel;
    private JTable eventTable;

    public MainDashboard() {
        setTitle("SATE - Monitor de Eventos y Alertas");
        // Establece el estado maximizado por defecto, típico de dashboards
        setExtendedState(JFrame.MAXIMIZED_BOTH); 
        setDefaultCloseOperation(JFrame.EXIT_ON_CLOSE);

        // Barra de Menú (JMenuBar)
        JMenuBar menuBar = new JMenuBar();
        menuBar.add(new JMenu("Archivo"));
        menuBar.add(new JMenu("Eventos"));
        JMenu validationMenu = new JMenu("Validación");
        validationMenu.add(new JMenuItem("Revisar Reportes Pendientes")).addActionListener(e -> {
            new ValidationScreen().setVisible(true);
        });
        menuBar.add(validationMenu);
        // Opción para testear la conexión a la DB
        JMenu testMenu = new JMenu("Test DB");
        testMenu.add(new JMenuItem("Probar Conexión")).addActionListener(e -> DBConnector.testConnection());
        menuBar.add(testMenu);
        menuBar.add(new JMenu("Administración"));
        menuBar.add(new JMenu("Ayuda"));
        setJMenuBar(menuBar);

        // Panel Dividido (JSplitPane) para el diseño principal
        JSplitPane splitPane = new JSplitPane(JSplitPane.HORIZONTAL_SPLIT);
        splitPane.setDividerLocation(350);

        // --- PANEL IZQUIERDO: Filtros y Tabla ---
        JPanel leftPanel = new JPanel(new BorderLayout());
        leftPanel.setBorder(BorderFactory.createTitledBorder("⚙️ Controles y Eventos"));

        // Panel superior para Filtros y Botones
        JPanel controlPanel = new JPanel(new BorderLayout());

        // Sub-panel para los filtros (GridBagLayout)
        JPanel filterPanel = new JPanel(new GridBagLayout());
        GridBagConstraints gbc = new GridBagConstraints();
        gbc.insets = new Insets(5, 5, 5, 5);
        gbc.fill = GridBagConstraints.HORIZONTAL;
        gbc.weightx = 1.0;

        // [Filtros]
        filterPanel.add(new JLabel("Filtrar por Tipo:"), gbc(0, 0, gbc));
        JComboBox<String> tipoComboBox = new JComboBox<>(new String[]{"Todos", "Inundación", "Incendio"});
        filterPanel.add(tipoComboBox, gbc(1, 0, gbc));

        filterPanel.add(new JLabel("Estado:"), gbc(0, 1, gbc));
        JPanel statusChecks = new JPanel(new FlowLayout(FlowLayout.LEFT));
        statusChecks.add(new JCheckBox("Aprobado", true));
        statusChecks.add(new JCheckBox("Pendiente", true));
        filterPanel.add(statusChecks, gbc(1, 1, gbc));

        // Panel de botones de acción
        JPanel actionButtonPanel = new JPanel(new FlowLayout(FlowLayout.CENTER, 10, 5));

        // 1. Botón Aplicar Filtros (CORREGIDO: llama a loadEvents)
        JButton applyButton = new JButton("Aplicar Filtros");
        applyButton.addActionListener(e -> {
            loadEvents(); // Recarga los datos (simula el filtrado)
            JOptionPane.showMessageDialog(this,
                "Simulando filtrado de eventos de tipo: " + tipoComboBox.getSelectedItem(),
                "Filtro Aplicado", JOptionPane.INFORMATION_MESSAGE);
        });

        // 2. Botón de Reporte Manual (NUEVO: abre la ventana ReporteManualScreen)
        JButton newReportButton = new JButton("➕ Nuevo Reporte Manual");
        newReportButton.addActionListener(e -> {
            new ReporteManualScreen().setVisible(true);
        });

        actionButtonPanel.add(applyButton);
        actionButtonPanel.add(newReportButton);

        controlPanel.add(filterPanel, BorderLayout.NORTH);
        controlPanel.add(actionButtonPanel, BorderLayout.SOUTH);

        // JTable para la lista de Eventos
        // Se añade la columna WKT para mostrar el polígono/punto del evento
        String[] columnNames = {"ID", "Tipo", "Fecha/Hora", "Ubicación (WKT)"};
        eventTable = new JTable(new DefaultTableModel(columnNames, 0));
        JScrollPane scrollPane = new JScrollPane(eventTable);

        leftPanel.add(controlPanel, BorderLayout.NORTH);
        leftPanel.add(scrollPane, BorderLayout.CENTER);

        // --- PANEL DERECHO: Mapa (Usa la clase GISMapPanel) ---
        mapPanel = new GISMapPanel();

        // Configurar el SplitPane
        splitPane.setLeftComponent(leftPanel);
        splitPane.setRightComponent(mapPanel);

        add(splitPane, BorderLayout.CENTER);

        // Barra de Estado
        JLabel statusBar = new JLabel("Estado: Conectado. Servidor DB: 10.0.100.24.");
        statusBar.setBorder(BorderFactory.createEtchedBorder());
        add(statusBar, BorderLayout.SOUTH);
        
        // Carga inicial de datos al finalizar la construcción de la UI
        loadEvents();
    }

    /**
     * Método para cargar los eventos desde la base de datos y actualizar la UI (tabla y mapa).
     */
    private void loadEvents() {
        // Llama al DBConnector para obtener los datos
        List<Evento> eventos = DBConnector.getEventos();

        // 1. Actualizar el Mapa GIS (pasa los datos al componente de dibujo)
        mapPanel.setEventos(eventos);

        // 2. Actualizar la Tabla (JTable)
        DefaultTableModel model = (DefaultTableModel) eventTable.getModel();
        model.setRowCount(0); // Limpiar filas existentes

        for (Evento evento : eventos) {
            // Se usa substring(0, 19) para limpiar la hora de milisegundos para una mejor presentación
            model.addRow(new Object[]{
                evento.getIdEvento(), 
                evento.getTipo(), 
                evento.getFechaHora().substring(0, 19),
                evento.getAreaAfectada()
            });
        }
    }

    // Métodos helper para configurar GridBagConstraints
    private GridBagConstraints gbc(int x, int y, GridBagConstraints base, int width) {
        base.gridx = x;
        base.gridy = y;
        base.gridwidth = width;
        return base;
    }
    private GridBagConstraints gbc(int x, int y, GridBagConstraints base) {
        return gbc(x, y, base, 1);
    }
}